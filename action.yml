name: 'OIDC'
description: 'Connect to AWS using OIDC'
inputs:
  oidc-conf:
    description: 'OIDC_CONF variable, generated by the deploy.sh script'
    required: true
outputs:
  aws-region:
    description: "AWS region"
    value: ${{ steps.oidc-parser.outputs.aws_region }}
runs:
  using: "composite"
  steps:
    - name: Parsing OIDC_CONF
      env:
        OIDC_CONF: ${{ inputs.oidc-conf }}
      shell: bash
      id: oidc-parser
      run: |
          BRANCH=$(git branch --show-current)
          echo $BRANCH
          ROLE=$(echo "$OIDC_CONF" | jq -r ".\"$BRANCH\".role")
          REGION=$(echo "$OIDC_CONF" | jq -r ".\"$BRANCH\".region")
          echo $ROLE
          echo $REGION
          echo "aws_role=$ROLE" >> $GITHUB_ENV
          echo "aws_region=$REGION" >> $GITHUB_ENV
          echo "aws_region=$REGION" >> $GITHUB_OUTPUT
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ env.aws_role }}
        aws-region: ${{ env.aws_region }}
        disable-retry: true
